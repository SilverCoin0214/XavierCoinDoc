`commitRoot`方法是`commit阶段`工作的起点。`fiberRootNode`会作为传参。

在`rootFiber.firstEffect`上保存了一条需要执行`副作用`的`Fiber节点`的单向链表`effectList`，这些`Fiber节点`的`updateQueue`中保存了变化的`props`。

除此之外，一些生命周期钩子（比如`componentDidXXX`）、`hook`（比如`useEffect`）需要在`commit`阶段执行。


`commit`阶段的主要工作（即`Renderer`的工作流程）分为三部分：

-   before mutation阶段（执行`DOM`操作前）
    
-   mutation阶段（执行`DOM`操作）
    
-   layout阶段（执行`DOM`操作后）



## before mutation阶段
```js
// 保存之前的优先级，以同步优先级执行，执行完毕后恢复之前优先级
const previousLanePriority = getCurrentUpdateLanePriority();
setCurrentUpdateLanePriority(SyncLanePriority);

// 将当前上下文标记为CommitContext，作为commit阶段的标志
const prevExecutionContext = executionContext;
executionContext |= CommitContext;

// 处理focus状态
focusedInstanceHandle = prepareForCommit(root.containerInfo);
shouldFireAfterActiveInstanceBlur = false;

// beforeMutation阶段的主函数
commitBeforeMutationEffects(finishedWork);

focusedInstanceHandle = null;
```

### commitBeforeMutationEffects
	1.  处理`DOM节点`渲染/删除后的 `autoFocus`、`blur` 逻辑。
	2.  调用`getSnapshotBeforeUpdate`生命周期钩子。
	3.  调度`useEffect`。


#### 调度`useEffect`
在`flushPassiveEffects`方法内部会从全局变量`rootWithPendingPassiveEffects`获取`effectList`。
在`flushPassiveEffects`方法内部会遍历`rootWithPendingPassiveEffects`（即`effectList`）执行`effect`回调函数。

`useEffect`异步调用分为三步：

1.  `before mutation阶段`在`scheduleCallback`中调度`flushPassiveEffects`
2.  `layout阶段`之后将`effectList`赋值给`rootWithPendingPassiveEffects`
3.  `scheduleCallback`触发`flushPassiveEffects`，`flushPassiveEffects`内部遍历`rootWithPendingPassiveEffects`




